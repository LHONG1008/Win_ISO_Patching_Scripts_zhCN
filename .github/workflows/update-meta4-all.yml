name: Update meta4 for all versions

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 2-14 * *'  # 每月 2-14 号每天 6:00 UTC

permissions:
  contents: write

jobs:
  update-meta4:
    runs-on: windows-latest

    steps:
      - name: Checkout repository at v2025.11d
        uses: actions/checkout@v4
        with:
          ref: v2025.11d
          fetch-depth: 0

      - name: Setup PowerShell module
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module PSWindowsUpdate -Force

      - name: Update meta4 files from Microsoft Catalog
        shell: pwsh
        run: |
          Set-Location $env:GITHUB_WORKSPACE

          $metaFiles = Get-ChildItem -Path scripts -Filter *.meta4 -Recurse

          foreach ($file in $metaFiles) {
              $xml = [xml](Get-Content $file.FullName)

              foreach ($f in $xml.metalink.file) {
                  # 尝试从 <file name> 中提取 KB 编号
                  if ($f.name -match "kb(\d+)") {
                      $kb = $matches[1]
                  } else {
                      Write-Warning "Cannot extract KB from $($f.name)"
                      continue
                  }

                  # 查询 Microsoft Catalog
                  $searchUrl = "https://www.catalog.update.microsoft.com/Search.aspx?q=KB$kb"
                  $html = Invoke-WebRequest $searchUrl -UseBasicParsing

                  if ($html.Content -match "ScopedViewInline.aspx\?updateid=([a-f0-9\-]+)") {
                      $updateId = $matches[1]
                      $detailUrl = "https://www.catalog.update.microsoft.com/ScopedViewInline.aspx?updateid=$updateId"
                      $detail = Invoke-WebRequest $detailUrl -UseBasicParsing

                      $fileName = ($detail.Content |
                          Select-String "downloadFiles\[0\].fileName\s*=\s*'([^']+)'" |
                          ForEach-Object { $_.Matches[0].Groups[1].Value })

                      $url = ($detail.Content |
                          Select-String "downloadFiles\[0\].url\s*=\s*'([^']+)'" |
                          ForEach-Object { $_.Matches[0].Groups[1].Value })

                      $hash = ($fileName -split '_')[-1] -replace '\.msu$|\.cab$', ''

                      if ($fileName -and $url -and $hash) {
                          # 只替换 name / hash / url
                          $f.name = $fileName
                          if ($f.hash) {
                              $f.hash.'#text' = $hash
                          } else {
                              $h = $xml.CreateElement("hash")
                              $h.SetAttribute("type","sha-1")
                              $h.InnerText = $hash
                              $f.AppendChild($h) | Out-Null
                          }

                          if ($f.url) {
                              $f.url = $url
                          } else {
                              $u = $xml.CreateElement("url")
                              $u.InnerText = $url
                              $f.AppendChild($u) | Out-Null
                          }

                          Write-Host "Updated $($file.FullName) for KB$kb"
                      }
                  } else {
                      Write-Warning "UpdateID not found for KB$kb"
                  }
              }

              # 写回原文件，保留 XML 样式
              $xml.Save($file.FullName)
          }

      - name: Commit changes to test branch
        shell: pwsh
        run: |
          Set-Location $env:GITHUB_WORKSPACE

          # 创建本地 test 分支（覆盖已存在的）
          git checkout -B test

          # 递归添加 scripts/ 下所有 .meta4 文件
          Get-ChildItem -Path scripts -Filter *.meta4 -Recurse | ForEach-Object { git add $_.FullName }

          # 检查是否有变更
          if (-not (git status --porcelain)) {
              Write-Host "No changes detected."
              exit 0
          }

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git commit -m "auto: update meta4 for latest Windows KB"

          # 显式 push 到远程 test 分支（解决 detached HEAD）
          git push origin HEAD:test --force
