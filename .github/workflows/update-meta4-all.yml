name: Update KB meta4

on:
  workflow_dispatch:
  schedule:
    - cron: '0 5 * * *'  # 每天 5 点运行，可按需修改

jobs:
  update-meta4:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # 需要完整历史记录以便推送

    - name: Setup PowerShell
      uses: microsoft/setup-powershell@v2
      with:
        pwsh-version: '7.3'

    - name: Run KB meta4 update script
      shell: pwsh
      run: |
        Set-Location $env:GITHUB_WORKSPACE

        $patchList = Get-Content patch_list.json | ConvertFrom-Json

        foreach ($patch in $patchList) {
            $id = $patch.Id
            $outFile = $patch.File

            if ($patch.Type -eq "KB") {
                Write-Host "Processing KB: $id ..."
                $searchUrl = "https://www.catalog.update.microsoft.com/Search.aspx?q=$id"
                $html = Invoke-WebRequest $searchUrl -UseBasicParsing

                if ($html.Content -notmatch "ScopedViewInline.aspx\?updateid=([a-f0-9\-]+)") {
                    Write-Warning "UpdateID not found for $id"
                    continue
                }

                $updateId = $matches[1]
                $detailUrl = "https://www.catalog.update.microsoft.com/ScopedViewInline.aspx?updateid=$updateId"
                $detail = Invoke-WebRequest $detailUrl -UseBasicParsing

                $fileName = ($detail.Content |
                    Select-String "downloadFiles\[0\].fileName\s*=\s*'([^']+)'" |
                    ForEach-Object { $_.Matches[0].Groups[1].Value })

                $url = ($detail.Content |
                    Select-String "downloadFiles\[0\].url\s*=\s*'([^']+)'" |
                    ForEach-Object { $_.Matches[0].Groups[1].Value })

                if (-not $fileName -or -not $url) {
                    Write-Warning "Failed to parse metadata for $id"
                    continue
                }

                $hash = ($fileName -split "_")[-1] -replace "\.(msu|cab)$",""

                $xml = @"
<?xml version="1.0" encoding="utf-8"?>
<metalink xmlns="urn:ietf:params:xml:ns:metalink">
  <file name="$fileName">
    <hash type="sha-1">$hash</hash>
    <url>$url</url>
  </file>
</metalink>
"@

                $xml | Out-File $outFile -Encoding UTF8
                Write-Host "Updated KB $id: $fileName"
            }
            elseif ($patch.Type -like "NET*") {
                Write-Host "Skipping .NET patch $id (keep existing meta4)"
            }
        }

    - name: Commit and push updates
      shell: pwsh
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        Set-Location $env:GITHUB_WORKSPACE
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"

        git add Scripts/**/*.meta4
        git commit -m "auto: update meta4 for latest Windows and .NET patches" -a -m "Auto-generated by workflow" || Write-Host "No changes to commit"
        git push origin HEAD:test || Write-Host "Nothing to push or failed"
