name: Update meta4 for all versions

on:
  workflow_dispatch:
  schedule:
    # 每月 2-14 号每天 6:00 UTC
    - cron: '0 6 2-14 * *'

permissions:
  contents: write

jobs:
  update-meta4:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PowerShell module
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module PSWindowsUpdate -Force

      - name: Scan existing meta4 files recursively
        shell: pwsh
        run: |
          Set-Location $env:GITHUB_WORKSPACE

          $metaFiles = Get-ChildItem -Path script -Filter *.meta4 -Recurse
          $patchList = @()

          foreach ($file in $metaFiles) {
              $relativePath = $file.FullName.Substring($env:GITHUB_WORKSPACE.Length + 1)

              if ($relativePath -match "netfx4\.8|netfx4\.81") {
                  $patchList += [PSCustomObject]@{
                      Type = "NET"
                      Id = $file.BaseName
                      File = $file.FullName
                  }
              } 
              elseif ($file.BaseName -match "^script_\d+") {
                  $patchList += [PSCustomObject]@{
                      Type = "KB"
                      Id = $file.BaseName
                      File = $file.FullName
                  }
              } 
              else {
                  Write-Host "Unknown meta4 found: $relativePath"
              }
          }

          $patchList | ConvertTo-Json -Depth 3 | Out-File patch_list.json -Encoding UTF8
          Write-Host "Found patches:"
          $patchList | Format-Table

      - name: Update meta4 from Catalog (skip existing)
        shell: pwsh
        run: |
          Set-Location $env:GITHUB_WORKSPACE
          $patchList = Get-Content patch_list.json | ConvertFrom-Json

          foreach ($patch in $patchList) {
              $id = $patch.Id
              $outFile = [string]$patch.File   # 确保为字符串

              # 只处理 KB，如果已经有文件则跳过
              if (($patch.Type -eq "KB") -and ($outFile -and (Test-Path $outFile))) {
                  Write-Host "$outFile exists, skipping"
                  continue
              }

              if ($patch.Type -eq "KB") {
                  Write-Host "Processing KB: $id ..."
                  $searchUrl = "https://www.catalog.update.microsoft.com/Search.aspx?q=$id"
                  $html = Invoke-WebRequest $searchUrl -UseBasicParsing

                  if ($html.Content -notmatch "ScopedViewInline.aspx\?updateid=([a-f0-9\-]+)") {
                      Write-Warning "UpdateID not found for $id"
                      continue
                  }

                  $updateId = $matches[1]
                  $detailUrl = "https://www.catalog.update.microsoft.com/ScopedViewInline.aspx?updateid=$updateId"
                  $detail = Invoke-WebRequest $detailUrl -UseBasicParsing

                  $fileName = ($detail.Content |
                      Select-String "downloadFiles\[0\].fileName\s*=\s*'([^']+)'" |
                      ForEach-Object { $_.Matches[0].Groups[1].Value })

                  $url = ($detail.Content |
                      Select-String "downloadFiles\[0\].url\s*=\s*'([^']+)'" |
                      ForEach-Object { $_.Matches[0].Groups[1].Value })

                  if (-not $fileName -or -not $url) {
                      Write-Warning "Failed to parse metadata for $id"
                      continue
                  }

                  $xmlLines = @()
                  $xmlLines += '<?xml version="1.0" encoding="utf-8"?>'
                  $xmlLines += '<metalink xmlns="urn:ietf:params:xml:ns:metalink">'
                  $xmlLines += "  <file name=`"$fileName`">"
                  $xmlLines += "    <url>$url</url>"
                  $xmlLines += '  </file>'
                  $xmlLines += '</metalink>'

                  $xmlLines | Out-File $outFile -Encoding UTF8
                  Write-Host "meta4 generated: $outFile"
              }
              elseif ($patch.Type -like "NET*") {
                  Write-Host "Skipping .NET patch $id (keep existing meta4)"
              }
          }

      - name: Commit changes if any
        shell: pwsh
        run: |
          Set-Location $env:GITHUB_WORKSPACE
          if (-not (git status --porcelain)) {
              Write-Host "No changes detected."
              exit 0
          }

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add script/*.meta4 patch_list.json
          git commit -m "auto: update meta4 for latest Windows and .NET patches"
          git push
