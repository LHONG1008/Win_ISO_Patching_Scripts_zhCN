name: Update Windows KB meta4

on:
  workflow_dispatch:

jobs:
  update-kb:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PowerShell
        uses: PowerShell/PowerShell@v7.3.9 # 官方 PowerShell Action
        with:
          version: '7.3'

      - name: Update KB meta4
        shell: pwsh
        run: |
          Set-Location $env:GITHUB_WORKSPACE

          $patchList = Get-Content patch_list.json | ConvertFrom-Json

          foreach ($patch in $patchList) {
              $id = $patch.Id
              $outFile = $patch.File

              if ($patch.Type -eq "KB" -and (Test-Path $outFile)) {
                  Write-Host "$outFile exists, skipping"
                  continue
              }

              if ($patch.Type -eq "KB") {
                  Write-Host "Processing KB: $id ..."

                  $searchUrl = "https://www.catalog.update.microsoft.com/Search.aspx?q=$id"
                  $html = Invoke-WebRequest $searchUrl -UseBasicParsing

                  if ($html.Content -notmatch "ScopedViewInline.aspx\?updateid=([a-f0-9\-]+)") {
                      Write-Warning "UpdateID not found for $id"
                      continue
                  }

                  $updateId = $matches[1]
                  $detailUrl = "https://www.catalog.update.microsoft.com/ScopedViewInline.aspx?updateid=$updateId"
                  $detail = Invoke-WebRequest $detailUrl -UseBasicParsing

                  $fileName = ($detail.Content |
                      Select-String "downloadFiles\[0\].fileName\s*=\s*'([^']+)'" |
                      ForEach-Object { $_.Matches[0].Groups[1].Value })

                  $url = ($detail.Content |
                      Select-String "downloadFiles\[0\].url\s*=\s*'([^']+)'" |
                      ForEach-Object { $_.Matches[0].Groups[1].Value })

                  $hash = ($fileName -split '_')[-1] -replace '\.msu|\.cab',''  # 从文件名抓 hash

                  if (-not $fileName -or -not $url) {
                      Write-Warning "Failed to parse metadata for $id"
                      continue
                  }

                  $xmlLines = @()
                  $xmlLines += '<?xml version="1.0" encoding="utf-8"?>'
                  $xmlLines += '<metalink xmlns="urn:ietf:params:xml:ns:metalink">'
                  $xmlLines += "  <file name=`"$fileName`">"
                  $xmlLines += "    <hash type=`"sha-1`">$hash</hash>"
                  $xmlLines += "    <url>$url</url>"
                  $xmlLines += '  </file>'
                  $xmlLines += '</metalink>'

                  $xmlLines | Out-File $outFile -Encoding UTF8
                  Write-Host "Updated KB $id: $fileName"
              }
              elseif ($patch.Type -like "NET*") {
                  Write-Host "Skipping .NET patch $id (keep existing meta4)"
              }
          }

      - name: Commit & Push changes
        shell: pwsh
        run: |
          Set-Location $env:GITHUB_WORKSPACE
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add Scripts/*.meta4
          git commit -m "auto: update meta4 for latest Windows and .NET patches" -a || Write-Host "No changes to commit"
          git push origin HEAD:test
