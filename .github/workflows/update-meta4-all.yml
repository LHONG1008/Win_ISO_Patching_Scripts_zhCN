name: Update Meta4 KBs

on:
  workflow_dispatch:

jobs:
  update_meta4:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: test  # 指定目标分支

      - name: Setup PowerShell
        uses: actions/setup-powershell@v2
        with:
          pwsh-version: '7.3'

      - name: Update KB meta4 files
        shell: pwsh
        run: |
          Set-Location $env:GITHUB_WORKSPACE

          $patchList = Get-Content patch_list.json | ConvertFrom-Json

          foreach ($patch in $patchList) {
              $id = $patch.Id
              $outFile = $patch.File

              if ($patch.Type -eq "KB" -and Test-Path $outFile) {
                  Write-Host "$outFile exists, updating KB entries..."
                  
                  [xml]$xml = Get-Content $outFile

                  foreach ($fileNode in $xml.metalink.file) {
                      $fileName = $fileNode.name
                      
                      if ($fileName -match 'kb([0-9]+)') {
                          $kbId = $matches[1]

                          $searchUrl = "https://www.catalog.update.microsoft.com/Search.aspx?q=$kbId"
                          $html = Invoke-WebRequest $searchUrl -UseBasicParsing
                          if ($html.Content -match "ScopedViewInline.aspx\?updateid=([a-f0-9\-]+)") {
                              $updateId = $matches[1]
                              $detailUrl = "https://www.catalog.update.microsoft.com/ScopedViewInline.aspx?updateid=$updateId"
                              $detail = Invoke-WebRequest $detailUrl -UseBasicParsing

                              $newName = ($detail.Content | Select-String "downloadFiles\[0\].fileName\s*=\s*'([^']+)'" | ForEach-Object { $_.Matches[0].Groups[1].Value })
                              $newUrl  = ($detail.Content | Select-String "downloadFiles\[0\].url\s*=\s*'([^']+)'" | ForEach-Object { $_.Matches[0].Groups[1].Value })
                              $newHash = ($newName -split '_')[-1] -replace '\.msu$|\.cab$', ''

                              if ($newName -and $newUrl -and $newHash) {
                                  $fileNode.name = $newName
                                  $fileNode.url = $newUrl
                                  $fileNode.hash = $newHash
                                  Write-Host "Updated KB${kbId}: $newName"
                              } else {
                                  Write-Warning "Failed to parse new info for KB${kbId}"
                              }
                          } else {
                              Write-Warning "UpdateID not found for KB${kbId}"
                          }
                      }
                  }

                  $xml.Save($outFile)
              }
              elseif ($patch.Type -like "NET*") {
                  Write-Host "Skipping .NET patch $id (keep existing meta4)"
              }
          }

      - name: Commit and Push changes
        shell: pwsh
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add Scripts/**/*.meta4
          git add patch_list.json
          git commit -m "auto: update meta4 for latest Windows and .NET patches" -a || Write-Host "No changes to commit"
          git push origin HEAD:test
