name: Update meta4 KBs

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *' # 每天 UTC 02:00 触发

jobs:
  update-meta4:
    runs-on: windows-latest
    defaults:
      run:
        shell: powershell
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"

      - name: Update meta4 KBs
        run: |
          # 进入仓库根目录
          Set-Location $env:GITHUB_WORKSPACE

          # 找到所有 meta4 文件
          $metaFiles = Get-ChildItem -Path .\Scripts -Recurse -Filter *.meta4

          foreach ($metaFile in $metaFiles) {
              Write-Host "Processing $($metaFile.FullName)..."
              [xml]$xml = Get-Content $metaFile.FullName

              $updated = $false

              foreach ($fileNode in $xml.metalink.file) {
                  $nameAttr = $fileNode.name
                  if ($nameAttr -match 'kb\d+') {
                      $kbId = $matches[0]
                      Write-Host "Found KB: $kbId"

                      # 构造 Microsoft Catalog 搜索 URL
                      $searchUrl = "https://www.catalog.update.microsoft.com/Search.aspx?q=$kbId"
                      try {
                          $html = Invoke-WebRequest $searchUrl -UseBasicParsing
                      } catch {
                          Write-Warning "Failed to fetch catalog for $kbId"
                          continue
                      }

                      if ($html.Content -notmatch "ScopedViewInline.aspx\?updateid=([a-f0-9\-]+)") {
                          Write-Warning "UpdateID not found for $kbId"
                          continue
                      }

                      $updateId = $matches[1]
                      $detailUrl = "https://www.catalog.update.microsoft.com/ScopedViewInline.aspx?updateid=$updateId"

                      try {
                          $detail = Invoke-WebRequest $detailUrl -UseBasicParsing
                      } catch {
                          Write-Warning "Failed to fetch detail for $kbId"
                          continue
                      }

                      # 提取文件名、URL 和 hash
                      $newName = ($detail.Content |
                          Select-String "downloadFiles\[0\].fileName\s*=\s*'([^']+)'" |
                          ForEach-Object { $_.Matches[0].Groups[1].Value })
                      $newUrl = ($detail.Content |
                          Select-String "downloadFiles\[0\].url\s*=\s*'([^']+)'" |
                          ForEach-Object { $_.Matches[0].Groups[1].Value })
                      $newHash = ($detail.Content |
                          Select-String "downloadFiles\[0\].fileHash\s*=\s*'([^']+)'" |
                          ForEach-Object { $_.Matches[0].Groups[1].Value })

                      if (-not $newName -or -not $newUrl -or -not $newHash) {
                          Write-Warning "Failed to parse metadata for $kbId"
                          continue
                      }

                      # 更新节点，保持 XML 结构
                      $fileNode.name = $newName
                      if ($fileNode.hash) {
                          $fileNode.hash = $newHash
                      } else {
                          $hashNode = $xml.CreateElement("hash")
                          $hashNode.SetAttribute("type","sha-1")
                          $hashNode.InnerText = $newHash
                          $fileNode.AppendChild($hashNode) | Out-Null
                      }

                      if ($fileNode.url) {
                          $fileNode.url = $newUrl
                      } else {
                          $urlNode = $xml.CreateElement("url")
                          $urlNode.InnerText = $newUrl
                          $fileNode.AppendChild($urlNode) | Out-Null
                      }

                      Write-Host "Updated KB ${kbId}: $newName"
                      $updated = $true
                  }
              }

              if ($updated) {
                  $xml.Save($metaFile.FullName)
                  Write-Host "Saved updated file: $($metaFile.FullName)"
              } else {
                  Write-Host "No KB updates for $($metaFile.FullName)"
              }
          }

      - name: Commit and push changes
        run: |
          git add Scripts/**/*.meta4
          git commit -m "auto: update meta4 for latest KBs" -ErrorAction SilentlyContinue
          git pull --rebase origin test
          git push origin HEAD:test
