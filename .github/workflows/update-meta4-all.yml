name: Update Windows KB meta4

on:
  workflow_dispatch:

jobs:
  update-kb-meta4:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup PowerShell
        uses: actions/setup-powershell@v2
        with:
          pwsh-version: '7.3'

      - name: Install HtmlAgilityPack
        shell: pwsh
        run: |
          Install-Package -Name HtmlAgilityPack -Source PSGallery -Force -Scope CurrentUser

      - name: Update meta4 files
        shell: pwsh
        run: |
          # 设置工作目录
          Set-Location $env:GITHUB_WORKSPACE

          # 遍历 Scripts 下所有 meta4 文件
          $metaFiles = Get-ChildItem -Path ".\Scripts" -Recurse -Filter "*.meta4"

          foreach ($file in $metaFiles) {
              Write-Host "Processing $($file.FullName)..."

              # 加载 XML
              [xml]$xml = Get-Content $file.FullName

              foreach ($node in $xml.metalink.file) {
                  $name = $node.name
                  if ($name -match "kb(\d+)") {
                      $kbId = $matches[1]
                      Write-Host "Found KB$kbId"

                      # 下载 Catalog 页面
                      $searchUrl = "https://www.catalog.update.microsoft.com/Search.aspx?q=KB$kbId"
                      $html = Invoke-WebRequest $searchUrl -UseBasicParsing

                      if ($html.Content -notmatch "ScopedViewInline.aspx\?updateid=([a-f0-9\-]+)") {
                          Write-Warning "UpdateID not found for KB$kbId"
                          continue
                      }
                      $updateId = $matches[1]
                      $detailUrl = "https://www.catalog.update.microsoft.com/ScopedViewInline.aspx?updateid=$updateId"
                      $detail = Invoke-WebRequest $detailUrl -UseBasicParsing

                      # 解析文件名和 URL
                      Add-Type -AssemblyName System.Web
                      $doc = New-Object HtmlAgilityPack.HtmlDocument
                      $doc.LoadHtml($detail.Content)

                      $fileNode = $doc.DocumentNode.SelectSingleNode("//script[contains(text(),'downloadFiles')]")


                      if ($fileNode -match "downloadFiles\[0\]\.fileName\s*=\s*'([^']+)'.*downloadFiles\[0\]\.url\s*=\s*'([^']+)'") {
                          $newName = $matches[1]
                          $newUrl  = $matches[2]

                          # 替换 XML
                          $node.name = $newName
                          $node.url = $newUrl

                          # hash 可选：如果 URL 中包含 hash 或自己计算
                          if ($newName -match "_([a-f0-9]{40})") {
                              $node.hash = $matches[1]
                          }

                          Write-Host "Updated KB$kbId: $newName"
                      } else {
                          Write-Warning "Failed to parse KB$kbId"
                      }
                  }
              }

              # 保存 XML
              $xml.Save($file.FullName)
          }

      - name: Commit & Push
        shell: pwsh
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add Scripts/**/*.meta4
          git commit -m "Auto update KB meta4"
          git push origin HEAD:test
